<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Clicker: Ultimate Edition</title>
    <style>
        :root {
            --primary: #0066ff;
            --secondary: #00ccff;
            --accent: #ff6600;
            --prestige: #cc66ff;
            --rebirth: #ff3366;
            --energy: gold;
            --dark-bg: #0a0a20;
            --darker-bg: #050510;
            --light-text: #ffffff;
            --dark-text: #333333;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--dark-bg);
            color: var(--light-text);
            margin: 0;
            padding: 0;
            overflow: hidden;
            user-select: none;
        }
        
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: 80px 1fr;
            grid-template-areas:
                "header header header"
                "sidebar main shop";
        }
        
        #header {
            grid-area: header;
            background-color: var(--darker-bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
        }
        
        #main-game {
            grid-area: main;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #sidebar {
            grid-area: sidebar;
            background-color: rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        #shop {
            grid-area: shop;
            background-color: rgba(0, 0, 0, 0.3);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        #clicker {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--primary), var(--secondary));
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.7);
            transition: transform 0.1s;
            position: relative;
            z-index: 10;
        }
        
        #clicker:active {
            transform: scale(0.95);
        }
        
        .click-value {
            pointer-events: none;
            font-size: 28px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
        }
        
        .resource-display {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .resource-value {
            color: var(--energy);
            font-weight: bold;
        }
        
        .prestige-value {
            color: var(--prestige);
            font-weight: bold;
        }
        
        .rebirth-value {
            color: var(--rebirth);
            font-weight: bold;
        }
        
        .section-title {
            font-size: 18px;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--secondary);
        }
        
        .upgrade-item {
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(50, 50, 100, 0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .upgrade-item:hover {
            background-color: rgba(70, 70, 120, 0.5);
            border-left: 3px solid var(--secondary);
        }
        
        .upgrade-item.disabled {
            background-color: rgba(50, 50, 50, 0.3);
            color: #777;
            cursor: not-allowed;
            border-left: 3px solid transparent;
        }
        
        .upgrade-item.owned {
            background-color: rgba(0, 100, 0, 0.3);
            border-left: 3px solid #00ff00;
        }
        
        .upgrade-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .upgrade-description {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .upgrade-cost {
            font-size: 14px;
            color: var(--energy);
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 5px 10px;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.3);
            margin-right: 5px;
            border-radius: 3px;
        }
        
        .tab.active {
            background-color: var(--primary);
        }
        
        .prestige-button {
            background-color: var(--prestige);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .prestige-button:hover {
            background-color: #aa44ff;
            transform: scale(1.05);
        }
        
        .rebirth-button {
            background-color: var(--rebirth);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .rebirth-button:hover {
            background-color: #ff5588;
            transform: scale(1.05);
        }
        
        .progress-bar {
            height: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }
        
        .achievement {
            padding: 8px;
            margin-bottom: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border-left: 3px solid gold;
        }
        
        .achievement.unlocked {
            background-color: rgba(255, 215, 0, 0.1);
        }
        
        .achievement-name {
            font-weight: bold;
            color: gold;
        }
        
        .achievement-desc {
            font-size: 12px;
        }
        
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background-color: rgba(0, 100, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .milestone-reached {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            background-color: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
            opacity: 0;
            transition: all 0.5s;
            pointer-events: none;
        }
        
        .milestone-reached.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .milestone-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .toggle-section {
            cursor: pointer;
            user-select: none;
        }
        
        .toggle-section::before {
            content: "â–¼";
            display: inline-block;
            margin-right: 5px;
            font-size: 10px;
            transition: transform 0.2s;
        }
        
        .toggle-section.collapsed::before {
            transform: rotate(-90deg);
        }
        
        .collapsible {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .collapsed-content {
            max-height: 0;
        }
        
        .expanded-content {
            max-height: 1000px;
        }
        
        /* Responsive design */
        @media (max-width: 1000px) {
            #game-container {
                grid-template-columns: 200px 1fr;
                grid-template-areas:
                    "header header"
                    "sidebar main";
            }
            
            #shop {
                position: fixed;
                top: 0;
                right: 0;
                width: 300px;
                height: 100vh;
                transform: translateX(100%);
                transition: transform 0.3s;
                z-index: 200;
            }
            
            #shop.show {
                transform: translateX(0);
            }
            
            #mobile-shop-toggle {
                display: block;
            }
        }
        
        #mobile-shop-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 150;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <div class="resource-display">
                Cosmic Energy: <span id="resources" class="resource-value">0</span>
            </div>
            <div>
                Prestige: <span id="prestige-level" class="prestige-value">0</span> |
                Rebirth: <span id="rebirth-level" class="rebirth-value">0</span>
            </div>
        </div>
        
        <div id="sidebar">
            <div class="section-title toggle-section">Stats</div>
            <div class="collapsible expanded-content">
                <div>Click Power: <span id="click-power">1</span></div>
                <div>Auto-Clickers: <span id="auto-clickers">0</span></div>
                <div>Auto-Click Rate: <span id="auto-rate">0</span>/sec</div>
                <div>Prestige Bonus: <span id="prestige-bonus">1</span>x</div>
                <div>Rebirth Bonus: <span id="rebirth-bonus">1</span>x</div>
                <div>Total Clicks: <span id="total-clicks">0</span></div>
                <div>Total Energy: <span id="total-energy">0</span></div>
                <div>Play Time: <span id="play-time">0</span>s</div>
                
                <div class="section-title" style="margin-top: 20px;">Milestones</div>
                <div id="milestones-list"></div>
            </div>
            
            <div class="section-title toggle-section">Achievements</div>
            <div class="collapsible collapsed-content">
                <div id="achievements-list"></div>
            </div>
            
            <div class="section-title">Prestige</div>
            <div>
                <div>Next at: <span id="prestige-cost">100,000</span> energy</div>
                <div>Bonus: <span id="next-prestige-bonus">1.5</span>x</div>
                <button id="prestige-button" class="prestige-button">Prestige</button>
            </div>
            
            <div class="section-title">Rebirth</div>
            <div>
                <div>Next at: <span id="rebirth-cost">1,000,000</span> energy</div>
                <div>Bonus: <span id="next-rebirth-bonus">2</span>x</div>
                <button id="rebirth-button" class="rebirth-button">Rebirth</button>
            </div>
        </div>
        
        <div id="main-game">
            <div id="clicker">
                <div class="click-value">+1</div>
            </div>
        </div>
        
        <div id="shop">
            <div class="tab-container">
                <div class="tab active" data-tab="click">Click</div>
                <div class="tab" data-tab="auto">Auto</div>
                <div class="tab" data-tab="prestige">Prestige</div>
                <div class="tab" data-tab="rebirth">Rebirth</div>
            </div>
            
            <div id="click-upgrades" class="upgrade-tab">
                <!-- Click upgrades will be generated here -->
            </div>
            
            <div id="auto-upgrades" class="upgrade-tab" style="display: none;">
                <!-- Auto-clicker upgrades will be generated here -->
            </div>
            
            <div id="prestige-upgrades" class="upgrade-tab" style="display: none;">
                <!-- Prestige upgrades will be generated here -->
            </div>
            
            <div id="rebirth-upgrades" class="upgrade-tab" style="display: none;">
                <!-- Rebirth upgrades will be generated here -->
            </div>
        </div>
        
        <div id="mobile-shop-toggle">ðŸ›’</div>
        
        <div class="notification" id="notification">
            <div id="notification-message"></div>
        </div>
        
        <div class="milestone-reached" id="milestone-reached">
            <div class="milestone-title">Milestone Reached!</div>
            <div id="milestone-message"></div>
        </div>
    </div>

    <script>
        // =============================================
        // Game State and Configuration
        // =============================================
        const game = {
            // Core resources
            resources: 0,
            totalResources: 0,
            clicks: 0,
            
            // Click mechanics
            clickPower: 1,
            baseClickPower: 1,
            clickMultiplier: 1,
            
            // Auto-clicker mechanics
            autoClickers: 0,
            autoClickerCost: 15,
            autoClickRate: 0,
            autoClickMultiplier: 1,
            
            // Prestige system
            prestigeLevel: 0,
            prestigePoints: 0,
            prestigeBonus: 1,
            nextPrestigeAt: 100000,
            prestigeMultiplier: 1.5,
            
            // Rebirth system
            rebirthLevel: 0,
            rebirthPoints: 0,
            rebirthBonus: 1,
            nextRebirthAt: 1000000,
            rebirthMultiplier: 2,
            
            // Upgrades
            upgrades: {
                click: [],
                auto: [],
                prestige: [],
                rebirth: []
            },
            
            // Achievements
            achievements: [],
            
            // Milestones
            milestones: [],
            
            // Game state
            startTime: Date.now(),
            playTime: 0,
            lastUpdate: Date.now(),
            lastAutoClick: Date.now(),
            particles: [],
            notifications: []
        };

        // =============================================
        // Upgrade Definitions
        // =============================================
        
        // Click Upgrades (50 total)
        for (let i = 1; i <= 50; i++) {
            const cost = Math.floor(10 * Math.pow(1.15, i));
            const power = 1 + Math.floor(i / 10);
            
            game.upgrades.click.push({
                id: `click_${i}`,
                name: `Click Power ${i}`,
                description: `Increases click power by ${power}`,
                cost: cost,
                purchased: false,
                effect: () => { game.baseClickPower += power; }
            });
        }
        
        // Auto Clicker Upgrades (50 total)
        for (let i = 1; i <= 50; i++) {
            const cost = Math.floor(50 * Math.pow(1.2, i));
            const multiplier = 1 + (i * 0.1);
            
            game.upgrades.auto.push({
                id: `auto_${i}`,
                name: `Auto-Clicker Boost ${i}`,
                description: `Multiplies auto-clicker efficiency by ${multiplier.toFixed(1)}x`,
                cost: cost,
                purchased: false,
                effect: () => { game.autoClickMultiplier *= multiplier; }
            });
        }
        
        // Prestige Upgrades (50 total)
        for (let i = 1; i <= 50; i++) {
            const cost = Math.floor(5 * Math.pow(2, i));
            const bonus = 1 + (i * 0.05);
            
            game.upgrades.prestige.push({
                id: `prestige_${i}`,
                name: `Prestige Boost ${i}`,
                description: `Increases prestige bonus by ${bonus.toFixed(2)}x`,
                cost: cost,
                purchased: false,
                effect: () => { game.prestigeMultiplier += 0.05; },
                requiresPrestige: true
            });
        }
        
        // Rebirth Upgrades (50 total)
        for (let i = 1; i <= 50; i++) {
            const cost = Math.floor(10 * Math.pow(2, i));
            const bonus = 1 + (i * 0.1);
            
            game.upgrades.rebirth.push({
                id: `rebirth_${i}`,
                name: `Rebirth Boost ${i}`,
                description: `Increases rebirth bonus by ${bonus.toFixed(2)}x`,
                cost: cost,
                purchased: false,
                effect: () => { game.rebirthMultiplier += 0.1; },
                requiresRebirth: true
            });
        }
        
        // =============================================
        // Achievement Definitions
        // =============================================
        
        // Click achievements
        game.achievements.push(
            { id: 'click_100', name: '100 Clicks', description: 'Perform 100 clicks', check: () => game.clicks >= 100, unlocked: false },
            { id: 'click_1000', name: '1,000 Clicks', description: 'Perform 1,000 clicks', check: () => game.clicks >= 1000, unlocked: false },
            { id: 'click_10000', name: '10,000 Clicks', description: 'Perform 10,000 clicks', check: () => game.clicks >= 10000, unlocked: false },
            { id: 'click_power_10', name: 'Power 10', description: 'Reach 10 click power', check: () => game.clickPower >= 10, unlocked: false },
            { id: 'click_power_100', name: 'Power 100', description: 'Reach 100 click power', check: () => game.clickPower >= 100, unlocked: false }
        );
        
        // Resource achievements
        game.achievements.push(
            { id: 'energy_1000', name: '1,000 Energy', description: 'Collect 1,000 cosmic energy', check: () => game.totalResources >= 1000, unlocked: false },
            { id: 'energy_1M', name: '1 Million Energy', description: 'Collect 1,000,000 cosmic energy', check: () => game.totalResources >= 1000000, unlocked: false },
            { id: 'energy_1B', name: '1 Billion Energy', description: 'Collect 1,000,000,000 cosmic energy', check: () => game.totalResources >= 1000000000, unlocked: false }
        );
        
        // Prestige achievements
        game.achievements.push(
            { id: 'prestige_1', name: 'First Prestige', description: 'Perform your first prestige', check: () => game.prestigeLevel >= 1, unlocked: false },
            { id: 'prestige_10', name: 'Prestige Master', description: 'Reach prestige level 10', check: () => game.prestigeLevel >= 10, unlocked: false }
        );
        
        // Rebirth achievements
        game.achievements.push(
            { id: 'rebirth_1', name: 'First Rebirth', description: 'Perform your first rebirth', check: () => game.rebirthLevel >= 1, unlocked: false },
            { id: 'rebirth_5', name: 'Rebirth Master', description: 'Reach rebirth level 5', check: () => game.rebirthLevel >= 5, unlocked: false }
        );
        
        // =============================================
        // Milestone Definitions
        // =============================================
        
        game.milestones = [
            { amount: 1000, message: "1,000 Energy - Auto-clickers unlocked!" },
            { amount: 10000, message: "10,000 Energy - Prestige upgrades unlocked!" },
            { amount: 100000, message: "100,000 Energy - Rebirth system unlocked!" },
            { amount: 1000000, message: "1,000,000 Energy - You're getting powerful!" },
            { amount: 1000000000, message: "1,000,000,000 Energy - Cosmic Overlord!" }
        ];
        
        // =============================================
        // DOM Elements
        // =============================================
        const elements = {
            // Core elements
            gameContainer: document.getElementById('game-container'),
            clicker: document.getElementById('clicker'),
            clickValue: document.querySelector('.click-value'),
            
            // Resource displays
            resources: document.getElementById('resources'),
            totalEnergy: document.getElementById('total-energy'),
            clickPower: document.getElementById('click-power'),
            autoClickers: document.getElementById('auto-clickers'),
            autoRate: document.getElementById('auto-rate'),
            prestigeLevel: document.getElementById('prestige-level'),
            rebirthLevel: document.getElementById('rebirth-level'),
            prestigeBonus: document.getElementById('prestige-bonus'),
            rebirthBonus: document.getElementById('rebirth-bonus'),
            totalClicks: document.getElementById('total-clicks'),
            playTime: document.getElementById('play-time'),
            
            // Prestige/Rebirth
            prestigeCost: document.getElementById('prestige-cost'),
            nextPrestigeBonus: document.getElementById('next-prestige-bonus'),
            prestigeButton: document.getElementById('prestige-button'),
            rebirthCost: document.getElementById('rebirth-cost'),
            nextRebirthBonus: document.getElementById('next-rebirth-bonus'),
            rebirthButton: document.getElementById('rebirth-button'),
            
            // Shop tabs
            shopTabs: document.querySelectorAll('.tab'),
            clickUpgrades: document.getElementById('click-upgrades'),
            autoUpgrades: document.getElementById('auto-upgrades'),
            prestigeUpgrades: document.getElementById('prestige-upgrades'),
            rebirthUpgrades: document.getElementById('rebirth-upgrades'),
            
            // Achievements
            achievementsList: document.getElementById('achievements-list'),
            milestonesList: document.getElementById('milestones-list'),
            
            // UI
            notification: document.getElementById('notification'),
            notificationMessage: document.getElementById('notification-message'),
            milestoneReached: document.getElementById('milestone-reached'),
            milestoneMessage: document.getElementById('milestone-message'),
            mobileShopToggle: document.getElementById('mobile-shop-toggle'),
            
            // Collapsible sections
            toggleSections: document.querySelectorAll('.toggle-section'),
            collapsibles: document.querySelectorAll('.collapsible')
        };
        
        // =============================================
        // Game Initialization
        // =============================================
        function init() {
            // Set up event listeners
            elements.clicker.addEventListener('click', handleClick);
            elements.prestigeButton.addEventListener('click', performPrestige);
            elements.rebirthButton.addEventListener('click', performRebirth);
            
            // Shop tab switching
            elements.shopTabs.forEach(tab => {
                tab.addEventListener('click', () => switchShopTab(tab.dataset.tab));
            });
            
            // Collapsible sections
            elements.toggleSections.forEach((section, index) => {
                section.addEventListener('click', () => {
                    section.classList.toggle('collapsed');
                    elements.collapsibles[index].classList.toggle('collapsed-content');
                    elements.collapsibles[index].classList.toggle('expanded-content');
                });
            });
            
            // Mobile shop toggle
            elements.mobileShopToggle.addEventListener('click', () => {
                document.getElementById('shop').classList.toggle('show');
            });
            
            // Generate upgrade elements
            generateUpgradeElements();
            
            // Generate achievement elements
            generateAchievementElements();
            
            // Generate milestone elements
            generateMilestoneElements();
            
            // Load game from localStorage if available
            loadGame();
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        }
        
        // =============================================
        // Game Loop
        // =============================================
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - game.lastUpdate) / 1000; // Convert to seconds
            game.lastUpdate = now;
            
            // Update game state
            update(deltaTime);
            
            // Render game
            render();
            
            // Continue loop
            requestAnimationFrame(gameLoop);
        }
        
        function update(deltaTime) {
            // Update play time
            game.playTime += deltaTime;
            
            // Auto-clicker logic
            const now = Date.now();
            if (now - game.lastAutoClick >= 1000 && game.autoClickers > 0) {
                const autoGain = game.autoClickers * game.autoClickMultiplier * game.prestigeBonus * game.rebirthBonus;
                game.resources += autoGain;
                game.totalResources += autoGain;
                game.lastAutoClick = now;
                
                // Create particles for auto-clickers
                createParticles(5);
            }
            
            // Update particles
            game.particles.forEach((particle, index) => {
                particle.x += Math.cos(particle.angle) * particle.speed;
                particle.y += Math.sin(particle.angle) * particle.speed;
                particle.life--;
                particle.size = Math.max(0, particle.size - 0.05);
                
                if (particle.life <= 0) {
                    game.particles.splice(index, 1);
                    if (particle.element.parentNode) {
                        particle.element.parentNode.removeChild(particle.element);
                    }
                }
            });
            
            // Update click power calculation
            game.clickPower = game.baseClickPower * game.clickMultiplier * game.prestigeBonus * game.rebirthBonus;
            
            // Update auto click rate
            game.autoClickRate = game.autoClickers * game.autoClickMultiplier * game.prestigeBonus * game.rebirthBonus;
            
            // Check achievements
            checkAchievements();
            
            // Check milestones
            checkMilestones();
            
            // Update next prestige/rebirth costs
            game.nextPrestigeAt = 100000 * Math.pow(2, game.prestigeLevel);
            game.nextRebirthAt = 1000000 * Math.pow(3, game.rebirthLevel);
            
            // Update next bonuses
            game.nextPrestigeBonus = Math.pow(game.prestigeMultiplier, game.prestigeLevel + 1);
            game.nextRebirthBonus = Math.pow(game.rebirthMultiplier, game.rebirthLevel + 1);
        }
        
        function render() {
            // Update resource displays
            elements.resources.textContent = formatNumber(game.resources);
            elements.totalEnergy.textContent = formatNumber(game.totalResources);
            elements.clickPower.textContent = formatNumber(game.clickPower);
            elements.clickValue.textContent = `+${formatNumber(game.clickPower)}`;
            elements.autoClickers.textContent = game.autoClickers;
            elements.autoRate.textContent = formatNumber(game.autoClickRate);
            elements.prestigeLevel.textContent = game.prestigeLevel;
            elements.rebirthLevel.textContent = game.rebirthLevel;
            elements.prestigeBonus.textContent = formatNumber(game.prestigeBonus);
            elements.rebirthBonus.textContent = formatNumber(game.rebirthBonus);
            elements.totalClicks.textContent = formatNumber(game.clicks);
            elements.playTime.textContent = Math.floor(game.playTime);
            
            // Update prestige/rebirth info
            elements.prestigeCost.textContent = formatNumber(game.nextPrestigeAt);
            elements.nextPrestigeBonus.textContent = formatNumber(game.nextPrestigeBonus);
            elements.rebirthCost.textContent = formatNumber(game.nextRebirthAt);
            elements.nextRebirthBonus.textContent = formatNumber(game.nextRebirthBonus);
            
            // Update shop items
            updateShopItems();
            
            // Update achievements
            updateAchievementDisplay();
            
            // Update milestone progress
            updateMilestoneProgress();
            
            // Render particles
            game.particles.forEach(particle => {
                particle.element.style.left = `${particle.x}px`;
                particle.element.style.top = `${particle.y}px`;
                particle.element.style.width = `${particle.size}px`;
                particle.element.style.height = `${particle.size}px`;
                particle.element.style.backgroundColor = particle.color;
                particle.element.style.opacity = particle.life / 100;
            });
            
            // Handle notifications
            if (game.notifications.length > 0) {
                showNotification(game.notifications[0]);
                game.notifications.shift();
            }
        }
        
        // =============================================
        // Game Mechanics
        // =============================================
        function handleClick() {
            game.resources += game.clickPower;
            game.totalResources += game.clickPower;
            game.clicks++;
            
            // Create particles
            const rect = elements.clicker.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            createParticles(10, centerX, centerY);
            
            // Animate click
            elements.clicker.style.transform = 'scale(0.95)';
            setTimeout(() => {
                elements.clicker.style.transform = 'scale(1)';
            }, 100);
        }
        
        function buyAutoClicker() {
            if (game.resources >= game.autoClickerCost) {
                game.resources -= game.autoClickerCost;
                game.autoClickers++;
                game.autoClickerCost = Math.floor(game.autoClickerCost * 1.15);
                showNotification(`Auto-clicker purchased! Total: ${game.autoClickers}`);
            }
        }
        
        function buyUpgrade(type, index) {
            const upgrade = game.upgrades[type][index];
            
            if (!upgrade.purchased && game.resources >= upgrade.cost) {
                game.resources -= upgrade.cost;
                upgrade.purchased = true;
                upgrade.effect();
                
                if (upgrade.requiresPrestige) {
                    game.prestigePoints--;
                } else if (upgrade.requiresRebirth) {
                    game.rebirthPoints--;
                }
                
                showNotification(`Upgrade purchased: ${upgrade.name}`);
            }
        }
        
        function performPrestige() {
            if (game.resources >= game.nextPrestigeAt) {
                game.prestigeLevel++;
                game.prestigeBonus = Math.pow(game.prestigeMultiplier, game.prestigeLevel);
                game.prestigePoints += Math.floor(Math.log10(game.resources));
                
                // Reset game state but keep prestige bonuses
                game.resources = 0;
                game.baseClickPower = 1;
                game.clickMultiplier = 1;
                game.autoClickers = 0;
                game.autoClickerCost = 15;
                game.autoClickMultiplier = 1;
                
                // Reset non-prestige upgrades
                game.upgrades.click.forEach(upgrade => upgrade.purchased = false);
                game.upgrades.auto.forEach(upgrade => upgrade.purchased = false);
                
                showMilestone(`Prestige ${game.prestigeLevel} achieved!`);
                showNotification(`Prestige successful! Gained ${game.prestigePoints} prestige points`);
                
                // Create prestige particles
                createParticles(100);
            }
        }
        
        function performRebirth() {
            if (game.resources >= game.nextRebirthAt) {
                game.rebirthLevel++;
                game.rebirthBonus = Math.pow(game.rebirthMultiplier, game.rebirthLevel);
                game.rebirthPoints += Math.floor(Math.log10(game.resources / 1000000));
                
                // Reset game state but keep rebirth bonuses
                game.resources = 0;
                game.prestigeLevel = 0;
                game.prestigeBonus = 1;
                game.baseClickPower = 1;
                game.clickMultiplier = 1;
                game.autoClickers = 0;
                game.autoClickerCost = 15;
                game.autoClickMultiplier = 1;
                
                // Reset all upgrades except rebirth
                game.upgrades.click.forEach(upgrade => upgrade.purchased = false);
                game.upgrades.auto.forEach(upgrade => upgrade.purchased = false);
                game.upgrades.prestige.forEach(upgrade => upgrade.purchased = false);
                
                showMilestone(`Rebirth ${game.rebirthLevel} achieved!`);
                showNotification(`Rebirth successful! Gained ${game.rebirthPoints} rebirth points`);
                
                // Create rebirth particles
                createParticles(200, undefined, undefined, '#ff3366');
            }
        }
        
        // =============================================
        // UI Functions
        // =============================================
        function switchShopTab(tab) {
            // Update active tab
            elements.shopTabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
            
            // Show correct content
            document.querySelectorAll('.upgrade-tab').forEach(el => el.style.display = 'none');
            document.getElementById(`${tab}-upgrades`).style.display = 'block';
        }
        
        function generateUpgradeElements() {
            // Click upgrades
            game.upgrades.click.forEach((upgrade, index) => {
                const element = document.createElement('div');
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                element.innerHTML = `
                    <div class="upgrade-name">${upgrade.name}</div>
                    <div class="upgrade-description">${upgrade.description}</div>
                    <div class="upgrade-cost">Cost: ${formatNumber(upgrade.cost)} energy</div>
                `;
                element.addEventListener('click', () => buyUpgrade('click', index));
                elements.clickUpgrades.appendChild(element);
            });
            
            // Auto-clicker upgrades
            game.upgrades.auto.forEach((upgrade, index) => {
                const element = document.createElement('div');
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                element.innerHTML = `
                    <div class="upgrade-name">${upgrade.name}</div>
                    <div class="upgrade-description">${upgrade.description}</div>
                    <div class="upgrade-cost">Cost: ${formatNumber(upgrade.cost)} energy</div>
                `;
                element.addEventListener('click', () => buyUpgrade('auto', index));
                elements.autoUpgrades.appendChild(element);
            });
            
            // Prestige upgrades
            game.upgrades.prestige.forEach((upgrade, index) => {
                const element = document.createElement('div');
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                element.innerHTML = `
                    <div class="upgrade-name">${upgrade.name}</div>
                    <div class="upgrade-description">${upgrade.description}</div>
                    <div class="upgrade-cost">Cost: ${formatNumber(upgrade.cost)} prestige points</div>
                `;
                element.addEventListener('click', () => buyUpgrade('prestige', index));
                elements.prestigeUpgrades.appendChild(element);
            });
            
            // Rebirth upgrades
            game.upgrades.rebirth.forEach((upgrade, index) => {
                const element = document.createElement('div');
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                element.innerHTML = `
                    <div class="upgrade-name">${upgrade.name}</div>
                    <div class="upgrade-description">${upgrade.description}</div>
                    <div class="upgrade-cost">Cost: ${formatNumber(upgrade.cost)} rebirth points</div>
                `;
                element.addEventListener('click', () => buyUpgrade('rebirth', index));
                elements.rebirthUpgrades.appendChild(element);
            });
        }
        
        function updateShopItems() {
            // Click upgrades
            game.upgrades.click.forEach((upgrade, index) => {
                const element = elements.clickUpgrades.children[index];
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                if (!upgrade.purchased) {
                    element.classList.toggle('disabled', game.resources < upgrade.cost);
                }
            });
            
            // Auto-clicker upgrades
            game.upgrades.auto.forEach((upgrade, index) => {
                const element = elements.autoUpgrades.children[index];
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                if (!upgrade.purchased) {
                    element.classList.toggle('disabled', game.resources < upgrade.cost);
                }
            });
            
            // Prestige upgrades
            game.upgrades.prestige.forEach((upgrade, index) => {
                const element = elements.prestigeUpgrades.children[index];
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                if (!upgrade.purchased) {
                    element.classList.toggle('disabled', game.prestigePoints < upgrade.cost);
                }
            });
            
            // Rebirth upgrades
            game.upgrades.rebirth.forEach((upgrade, index) => {
                const element = elements.rebirthUpgrades.children[index];
                element.className = `upgrade-item ${upgrade.purchased ? 'owned' : ''}`;
                if (!upgrade.purchased) {
                    element.classList.toggle('disabled', game.rebirthPoints < upgrade.cost);
                }
            });
        }
        
        function generateAchievementElements() {
            game.achievements.forEach(achievement => {
                const element = document.createElement('div');
                element.className = `achievement ${achievement.unlocked ? 'unlocked' : ''}`;
                element.id = `achievement_${achievement.id}`;
                element.innerHTML = `
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                `;
                elements.achievementsList.appendChild(element);
            });
        }
        
        function updateAchievementDisplay() {
            game.achievements.forEach(achievement => {
                const element = document.getElementById(`achievement_${achievement.id}`);
                if (element) {
                    element.className = `achievement ${achievement.unlocked ? 'unlocked' : ''}`;
                }
            });
        }
        
        function generateMilestoneElements() {
            game.milestones.forEach(milestone => {
                const element = document.createElement('div');
                element.className = 'milestone';
                element.innerHTML = `
                    <div>${formatNumber(milestone.amount)} Energy</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="milestone_${milestone.amount}"></div>
                    </div>
                `;
                elements.milestonesList.appendChild(element);
            });
        }
        
        function updateMilestoneProgress() {
            game.milestones.forEach(milestone => {
                const progress = Math.min(100, (game.totalResources / milestone.amount) * 100);
                const element = document.getElementById(`milestone_${milestone.amount}`);
                if (element) {
                    element.style.width = `${progress}%`;
                }
            });
        }
        
        function checkAchievements() {
            game.achievements.forEach(achievement => {
                if (!achievement.unlocked && achievement.check()) {
                    achievement.unlocked = true;
                    showNotification(`Achievement unlocked: ${achievement.name}`);
                }
            });
        }
        
        function checkMilestones() {
            game.milestones.forEach(milestone => {
                if (game.totalResources >= milestone.amount && !milestone.reached) {
                    milestone.reached = true;
                    showMilestone(milestone.message);
                }
            });
        }
        
        function showNotification(message) {
            game.notifications.push(message);
        }
        
        function displayNotification(message) {
            elements.notificationMessage.textContent = message;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }
        
        function showMilestone(message) {
            elements.milestoneMessage.textContent = message;
            elements.milestoneReached.classList.add('show');
            
            setTimeout(() => {
                elements.milestoneReached.classList.remove('show');
            }, 3000);
        }
        
        function createParticles(count, x, y, color) {
            const centerX = x || Math.random() * window.innerWidth;
            const centerY = y || Math.random() * window.innerHeight;
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 3;
                const size = 2 + Math.random() * 5;
                const life = 30 + Math.random() * 50;
                const particleColor = color || `hsl(${Math.random() * 60 + 200}, 100%, 70%)`;
                
                game.particles.push({
                    x: centerX,
                    y: centerY,
                    angle: angle,
                    speed: speed,
                    size: size,
                    life: life,
                    color: particleColor,
                    element: particle
                });
                
                document.body.appendChild(particle);
            }
        }
        
        // =============================================
        // Utility Functions
        // =============================================
        function formatNumber(num) {
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return Math.floor(num).toString();
        }
        
        function saveGame() {
            const saveData = {
                resources: game.resources,
                totalResources: game.totalResources,
                clicks: game.clicks,
                baseClickPower: game.baseClickPower,
                clickMultiplier: game.clickMultiplier,
                autoClickers: game.autoClickers,
                autoClickerCost: game.autoClickerCost,
                autoClickMultiplier: game.autoClickMultiplier,
                prestigeLevel: game.prestigeLevel,
                prestigePoints: game.prestigePoints,
                prestigeBonus: game.prestigeBonus,
                prestigeMultiplier: game.prestigeMultiplier,
                rebirthLevel: game.rebirthLevel,
                rebirthPoints: game.rebirthPoints,
                rebirthBonus: game.rebirthBonus,
                rebirthMultiplier: game.rebirthMultiplier,
                upgrades: game.upgrades,
                achievements: game.achievements,
                milestones: game.milestones,
                playTime: game.playTime,
                startTime: game.startTime
            };
            
            localStorage.setItem('cosmicClickerSave', JSON.stringify(saveData));
        }
        
        function loadGame() {
            const saveData = localStorage.getItem('cosmicClickerSave');
            if (saveData) {
                const parsed = JSON.parse(saveData);
                
                game.resources = parsed.resources || 0;
                game.totalResources = parsed.totalResources || 0;
                game.clicks = parsed.clicks || 0;
                game.baseClickPower = parsed.baseClickPower || 1;
                game.clickMultiplier = parsed.clickMultiplier || 1;
                game.autoClickers = parsed.autoClickers || 0;
                game.autoClickerCost = parsed.autoClickerCost || 15;
                game.autoClickMultiplier = parsed.autoClickMultiplier || 1;
                game.prestigeLevel = parsed.prestigeLevel || 0;
                game.prestigePoints = parsed.prestigePoints || 0;
                game.prestigeBonus = parsed.prestigeBonus || 1;
                game.prestigeMultiplier = parsed.prestigeMultiplier || 1.5;
                game.rebirthLevel = parsed.rebirthLevel || 0;
                game.rebirthPoints = parsed.rebirthPoints || 0;
                game.rebirthBonus = parsed.rebirthBonus || 1;
                game.rebirthMultiplier = parsed.rebirthMultiplier || 2;
                game.upgrades = parsed.upgrades || game.upgrades;
                game.achievements = parsed.achievements || game.achievements;
                game.milestones = parsed.milestones || game.milestones;
                game.playTime = parsed.playTime || 0;
                game.startTime = parsed.startTime || Date.now();
                
                // Calculate current play time
                game.playTime += (Date.now() - game.startTime) / 1000;
                
                showNotification('Game loaded successfully!');
            }
        }
        
        // Auto-save every 30 seconds
        setInterval(saveGame, 30000);
        
        // Save when page is closed
        window.addEventListener('beforeunload', saveGame);
        
        // Start the game
        init();
    </script>
</body>
</html>
